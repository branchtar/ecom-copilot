// =========================================================
// Project: Ecom Copilot
// File: ui-web/src/pages/SuppliersPage.tsx
// Purpose: Suppliers module (list/detail/edit placeholder) with block markers
// Generated by scaffolding/patch automation
// =========================================================

// <BLOCK:SUPPLIERS_IMPORTS>
import React, { useEffect, useMemo, useState } from "react";
// </BLOCK:SUPPLIERS_IMPORTS>

// <BLOCK:SUPPLIERS_TYPES>
type SupplierSummary = {
  id: string;
  key?: string; // e.g. "KMC"
  name: string;
  location?: string;
};

type SupplierDetail = SupplierSummary & {
  notes?: string;
  margin?: number;    // 0-1
  kmcMargin?: number; // 0-1
};

type KmcComputedRow = {
  sku: string;
  productName: string;
  brand: string;
  cost: number;
  marginUsed: number; // 0-1
  amazonPrice: number;
  shopifyPrice: number;
  walmartPrice: number;
};
// </BLOCK:SUPPLIERS_TYPES>

// <BLOCK:SUPPLIERS_HELPERS>
const API_BASE =
  (process.env.REACT_APP_API_BASE_URL as string) || "http://127.0.0.1:5000";

function asNumber(v: any, fallback = 0): number {
  const n = typeof v === "string" ? Number(v) : typeof v === "number" ? v : NaN;
  return Number.isFinite(n) ? n : fallback;
}

function normalizeKmcRow(raw: any): KmcComputedRow {
  return {
    sku: String(raw?.sku ?? ""),
    productName: String(raw?.productName ?? raw?.name ?? raw?.title ?? ""),
    brand: String(raw?.brand ?? raw?.vendor ?? ""),
    cost: asNumber(raw?.cost ?? raw?.unit_cost ?? raw?.unitCost, 0),
    marginUsed: asNumber(raw?.marginUsed ?? raw?.margin_used ?? raw?.margin, 0),
    amazonPrice: asNumber(raw?.amazonPrice ?? raw?.amazon_price, 0),
    shopifyPrice: asNumber(raw?.shopifyPrice ?? raw?.shopify_price, 0),
    walmartPrice: asNumber(raw?.walmartPrice ?? raw?.walmart_price, 0),
  };
}
// </BLOCK:SUPPLIERS_HELPERS>

// <BLOCK:SUPPLIERS_COMPONENT>
const SuppliersPage: React.FC = () => {
  const [mode, setMode] = useState<"list" | "detail" | "edit">("list");

  const [rows, setRows] = useState<SupplierSummary[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [detailLoading, setDetailLoading] = useState<boolean>(false);
  const [detailError, setDetailError] = useState<string | null>(null);
  const [detail, setDetail] = useState<SupplierDetail | null>(null);

  const [kmcRows, setKmcRows] = useState<KmcComputedRow[]>([]);
  const [kmcLoading, setKmcLoading] = useState<boolean>(false);
  const [kmcError, setKmcError] = useState<string | null>(null);

  const isKmc = useMemo(() => {
    const k =
      (detail?.key ?? (detail as any)?.supplier_key ?? detail?.name ?? "")
        .toString()
        .trim()
        .toUpperCase();
    return k === "KMC" || k.includes("KMC");
  }, [detail]);

  const kmcMargin = useMemo(() => {
    const v =
      detail?.kmcMargin ??
      (detail as any)?.kmc_margin ??
      (detail as any)?.margin ??
      null;
    return typeof v === "number" && Number.isFinite(v) ? v : null;
  }, [detail]);

  // Load suppliers list
  useEffect(() => {
    let cancelled = false;

    async function load() {
      setLoading(true);
      setError(null);

      try {
        const res = await fetch(`${API_BASE}/api/suppliers`, {
          headers: { Accept: "application/json" },
        });
        if (!res.ok) throw new Error(`HTTP ${res.status} loading suppliers`);

        const data = await res.json();
        const list = Array.isArray(data) ? data : data?.suppliers;

        const normalized: SupplierSummary[] = (Array.isArray(list) ? list : [])
          .map((s: any) => ({
            id: String(
              s?.id ??
                s?.key ??
                s?.name ??
                (globalThis.crypto?.randomUUID?.() ?? Math.random())
            ),
            key: s?.key ?? s?.supplier_key ?? s?.supplierKey,
            name: String(
              s?.name ?? s?.display_name ?? s?.displayName ?? "Unnamed Supplier"
            ),
            location: s?.location ?? s?.city ?? s?.state,
          }))
          .filter((s) => s.name && s.id);

        if (!cancelled) setRows(normalized);
      } catch (e: any) {
        if (!cancelled) setError(e?.message ?? "Failed to load suppliers");
      } finally {
        if (!cancelled) setLoading(false);
      }
    }

    load();
    return () => {
      cancelled = true;
    };
  }, []);

  // Load supplier detail
  useEffect(() => {
    const sid = selectedId;
    if (!sid) return;

let cancelled = false;

    async function loadDetail() {
      setDetailLoading(true);
      setDetailError(null);
      setDetail(null);

      try {
        const res = await fetch(
          `${API_BASE}/api/suppliers/${encodeURIComponent(sid)}`,
          { headers: { Accept: "application/json" } }
        );
        if (!res.ok) throw new Error(`HTTP ${res.status} loading supplier detail`);

        const d = await res.json();
        const normalized: SupplierDetail = {
          id: String(d?.id ?? selectedId),
          key: d?.key ?? d?.supplier_key ?? d?.supplierKey,
          name: String(d?.name ?? d?.display_name ?? d?.displayName ?? "Supplier"),
          location: d?.location ?? d?.city ?? d?.state,
          notes: d?.notes ?? d?.description,
          margin: typeof d?.margin === "number" ? d.margin : undefined,
          kmcMargin: typeof d?.kmcMargin === "number" ? d.kmcMargin : undefined,
        };

        if (!cancelled) setDetail(normalized);
      } catch (e: any) {
        if (!cancelled)
          setDetailError(e?.message ?? "Failed to load supplier detail");
      } finally {
        if (!cancelled) setDetailLoading(false);
      }
    }

    loadDetail();
    return () => {
      cancelled = true;
    };
  }, [selectedId]);

  // Load KMC pricing preview
  useEffect(() => {
    const sid = selectedId;
    if (mode !== "detail" || !sid) return;

if (!isKmc) {
      setKmcRows([]);
      setKmcError(null);
      setKmcLoading(false);
      return;
    }

    let cancelled = false;

    async function loadKmcPreview() {
      setKmcLoading(true);
      setKmcError(null);
      setKmcRows([]);

      try {
        const candidates = [
          `${API_BASE}/api/suppliers/${encodeURIComponent(sid)}/pricing_preview`,
          `${API_BASE}/api/kmc/pricing_preview`,
          `${API_BASE}/api/pricing/kmc_preview`,
        ];

        let payload: any = null;
        let lastErr: any = null;

        for (const url of candidates) {
          try {
            const res = await fetch(url, { headers: { Accept: "application/json" } });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            payload = await res.json();
            lastErr = null;
            break;
          } catch (err) {
            lastErr = err;
          }
        }

        if (lastErr && !payload) {
          throw new Error("Could not load KMC pricing preview (no endpoint responded).");
        }

        const list = Array.isArray(payload) ? payload : payload?.rows ?? payload?.data ?? [];
        const normalized = (Array.isArray(list) ? list : []).map(normalizeKmcRow);

        if (!cancelled) setKmcRows(normalized);
      } catch (e: any) {
        if (!cancelled)
          setKmcError(e?.message ?? "Failed to load KMC pricing preview");
      } finally {
        if (!cancelled) setKmcLoading(false);
      }
    }

    loadKmcPreview();
    return () => {
      cancelled = true;
    };
  }, [mode, selectedId, isKmc]);

  // <BLOCK:SUPPLIERS_LIST_VIEW>
  if (mode === "list") {
    return (
      <div className="flex-1 flex flex-col p-4">
        <div className="flex items-center justify-between mb-3">
          <div>
            <div className="text-lg font-semibold text-slate-900">Suppliers</div>
            <div className="text-xs text-slate-500">
              Manage supplier profiles and (later) pricing rules.
            </div>
          </div>

          <button
            className="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800"
            onClick={() => setMode("edit")}
          >
            Add Supplier
          </button>
        </div>

        {loading && (
          <div className="text-sm text-slate-600 bg-white rounded-xl shadow-sm p-4">
            Loading suppliers…
          </div>
        )}

        {!loading && error && (
          <div className="text-sm text-red-700 bg-red-50 border border-red-100 rounded-xl p-4">
            {error}
          </div>
        )}

        {!loading && !error && (
          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            <table className="w-full text-sm">
              <thead className="bg-slate-50 text-slate-600">
                <tr>
                  <th className="text-left px-3 py-2 font-medium">Name</th>
                  <th className="text-left px-3 py-2 font-medium">Key</th>
                  <th className="text-left px-3 py-2 font-medium">Location</th>
                  <th className="text-right px-3 py-2 font-medium">Action</th>
                </tr>
              </thead>
              <tbody>
                {rows.map((s) => (
                  <tr key={s.id} className="border-t border-slate-100">
                    <td className="px-3 py-2 text-slate-900">{s.name}</td>
                    <td className="px-3 py-2 text-slate-600">{s.key ?? "-"}</td>
                    <td className="px-3 py-2 text-slate-600">{s.location ?? "-"}</td>
                    <td className="px-3 py-2 text-right">
                      <button
                        className="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-800 text-xs"
                        onClick={() => {
                          setSelectedId(s.id);
                          setMode("detail");
                        }}
                      >
                        View
                      </button>
                    </td>
                  </tr>
                ))}

                {rows.length === 0 && (
                  <tr>
                    <td colSpan={4} className="px-3 py-6 text-center text-slate-500">
                      No suppliers yet.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        )}
      </div>
    );
  }
  // </BLOCK:SUPPLIERS_LIST_VIEW>

  // <BLOCK:SUPPLIERS_DETAIL_VIEW>
  if (mode === "detail") {
    return (
      <div className="flex-1 flex flex-col p-4">
        <div className="flex items-center justify-between mb-3">
          <button
            className="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-800 text-sm"
            onClick={() => {
              setMode("list");
              setSelectedId(null);
              setDetail(null);
              setDetailError(null);
              setKmcRows([]);
              setKmcError(null);
            }}
          >
            ← Back
          </button>

          <button
            className="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800"
            onClick={() => setMode("edit")}
          >
            Edit
          </button>
        </div>

        {detailLoading && (
          <div className="bg-white rounded-xl shadow-sm p-4 text-sm text-slate-600">
            Loading supplier…
          </div>
        )}

        {!detailLoading && detailError && (
          <div className="text-sm text-red-700 bg-red-50 border border-red-100 rounded-xl p-4">
            {detailError}
          </div>
        )}

        {!detailLoading && !detailError && detail && (
          <div>
            <section className="bg-white rounded-xl shadow-sm p-4">
              <div className="flex items-start justify-between">
                <div>
                  <div className="text-lg font-semibold text-slate-900">{detail.name}</div>
                  <div className="text-xs text-slate-500">
                    Key: {detail.key ?? "-"} • Location: {detail.location ?? "-"}
                  </div>
                </div>
              </div>

              {detail.notes && (
                <div className="mt-3 text-sm text-slate-700 whitespace-pre-wrap">
                  {detail.notes}
                </div>
              )}
            </section>

            {isKmc && (
              <section className="bg-white rounded-xl shadow-sm p-4 mt-4">
                <div className="flex items-center justify-between mb-2">
                  <div>
                    <div className="text-sm font-semibold text-slate-900">
                      KMC Pricing Preview
                    </div>
                    <div className="text-[11px] text-slate-500">
                      Margin source:{" "}
                      {typeof kmcMargin === "number"
                        ? `${(kmcMargin * 100).toFixed(1)}% min gross margin`
                        : "--"}
                    </div>
                  </div>
                </div>

                {kmcLoading && (
                  <div className="text-sm text-slate-600">Loading preview…</div>
                )}

                {!kmcLoading && kmcError && (
                  <div className="text-sm text-red-700 bg-red-50 border border-red-100 rounded-xl p-3">
                    {kmcError}
                  </div>
                )}

                {!kmcLoading && !kmcError && (
                  <div className="overflow-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-50 text-slate-600">
                        <tr>
                          <th className="text-left px-3 py-2 font-medium">SKU</th>
                          <th className="text-left px-3 py-2 font-medium">Name</th>
                          <th className="text-left px-3 py-2 font-medium">Brand</th>
                          <th className="text-right px-3 py-2 font-medium">Cost</th>
                          <th className="text-right px-3 py-2 font-medium">Margin</th>
                          <th className="text-right px-3 py-2 font-medium">Amazon</th>
                          <th className="text-right px-3 py-2 font-medium">Shopify</th>
                          <th className="text-right px-3 py-2 font-medium">Walmart</th>
                        </tr>
                      </thead>
                      <tbody>
                        {kmcRows.map((r: KmcComputedRow) => (
                          <tr key={r.sku} className="border-t border-slate-100">
                            <td className="px-3 py-2 text-slate-800">{r.sku}</td>
                            <td className="px-3 py-2 text-slate-700">{r.productName}</td>
                            <td className="px-3 py-2 text-slate-700">{r.brand}</td>
                            <td className="px-3 py-2 text-right text-slate-800">
                              ${r.cost.toFixed(2)}
                            </td>
                            <td className="px-3 py-2 text-right text-slate-800">
                              {(r.marginUsed * 100).toFixed(1)}%
                            </td>
                            <td className="px-3 py-2 text-right text-slate-800">
                              ${r.amazonPrice.toFixed(2)}
                            </td>
                            <td className="px-3 py-2 text-right text-slate-800">
                              ${r.shopifyPrice.toFixed(2)}
                            </td>
                            <td className="px-3 py-2 text-right text-slate-800">
                              ${r.walmartPrice.toFixed(2)}
                            </td>
                          </tr>
                        ))}

                        {kmcRows.length === 0 && (
                          <tr>
                            <td colSpan={8} className="px-3 py-6 text-center text-slate-500">
                              No preview rows returned yet.
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                )}
              </section>
            )}

            {!isKmc && (
              <section className="bg-white rounded-xl shadow-sm p-4 mt-4 text-xs text-slate-500">
                Pricing preview for this supplier will be wired up later. For now,
                only KMC has a sample pricing table.
              </section>
            )}
          </div>
        )}
      </div>
    );
  }
  // </BLOCK:SUPPLIERS_DETAIL_VIEW>

  // <BLOCK:SUPPLIERS_EDIT_VIEW>
  return (
    <div className="flex-1 flex flex-col p-4">
      <div className="flex items-center justify-between mb-3">
        <button
          className="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-800 text-sm"
          onClick={() => setMode(selectedId ? "detail" : "list")}
        >
          ← Back
        </button>

        <button
          className="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800"
          onClick={() => setMode(selectedId ? "detail" : "list")}
        >
          Save (later)
        </button>
      </div>

      <section className="bg-white rounded-xl shadow-sm p-4">
        <div className="text-lg font-semibold text-slate-900">Add / Edit Supplier</div>
        <div className="text-sm text-slate-600 mt-1">
          This form is a placeholder so the page compiles cleanly. We can wire the real
          create/update calls next.
        </div>

        <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label className="block text-xs text-slate-500 mb-1">Name</label>
            <input
              className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm"
              placeholder="Supplier name"
              defaultValue={detail?.name ?? ""}
            />
          </div>

          <div>
            <label className="block text-xs text-slate-500 mb-1">Key</label>
            <input
              className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm"
              placeholder="e.g. KMC"
              defaultValue={detail?.key ?? ""}
            />
          </div>

          <div className="md:col-span-2">
            <label className="block text-xs text-slate-500 mb-1">Notes</label>
            <textarea
              className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm min-h-[120px]"
              placeholder="Notes..."
              defaultValue={detail?.notes ?? ""}
            />
          </div>
        </div>
      </section>
    </div>
  );
  // </BLOCK:SUPPLIERS_EDIT_VIEW>
};

export default SuppliersPage;
// </BLOCK:SUPPLIERS_COMPONENT>

