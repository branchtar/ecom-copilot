from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()



# === EC_DASHBOARD_START ===
# Minimal dashboard endpoints so the UI stops showing "Could not reach API".
# Expand these later with real data sources.

@app.get("/health")
def health():
    return {"ok": True}

@app.get("/dashboard/kpis")
def dashboard_kpis():
    return {
        "total_sales_7d": 0,
        "orders_7d": 0,
        "returns_7d": 0,
        "items_sold_7d": 0
    }

@app.get("/dashboard/marketplace-balances")
def dashboard_marketplace_balances():
    # UI can render "No balances loaded yet."
    return []

@app.get("/dashboard/recent-orders")
def dashboard_recent_orders():
    # UI can render "No orders loaded yet."
    return []

@app.get("/dashboard/stock-alerts")
def dashboard_stock_alerts():
    # UI can render "No low stock alerts yet."
    return []
# === EC_DASHBOARD_END ===





# === EC_PRICING_START ===
# Pricing module (safe add-on)
import json
from pathlib import Path
from typing import Optional, List, Dict, Any
from pydantic import BaseModel

from pricing_engine import PricingRules, pricing_preview_row

_PRICING_RULES_PATH = Path(__file__).parent / "config" / "pricing_rules.json"

def _load_pricing_rules() -> Dict[str, Any]:
    if _PRICING_RULES_PATH.exists():
        return json.loads(_PRICING_RULES_PATH.read_text(encoding="utf-8"))
    return {"default": {"target_margin_pct": 0.30, "markup_pct": 0.50, "round_to": 0.01, "enforce_map": True}}

def _get_rules_for_supplier(supplier_key: str) -> PricingRules:
    data = _load_pricing_rules()
    base = data.get("default", {})
    sup  = data.get((supplier_key or "").lower(), {})
    merged = {**base, **sup}
    return PricingRules(
        target_margin_pct=float(merged.get("target_margin_pct", 0.30)),
        markup_pct=float(merged.get("markup_pct", 0.50)),
        round_to=float(merged.get("round_to", 0.01)),
        enforce_map=bool(merged.get("enforce_map", True)),
    )

class PricingItem(BaseModel):
    sku: str
    cost: float
    map_price: Optional[float] = None

class PricingPreviewRequest(BaseModel):
    supplier_key: str = "default"
    items: List[PricingItem]

@app.get("/pricing/rules")
def pricing_rules():
    return _load_pricing_rules()

@app.post("/pricing/preview")
def pricing_preview(req: PricingPreviewRequest):
    rules = _get_rules_for_supplier(req.supplier_key)
    rows = []
    for it in req.items:
        rows.append(pricing_preview_row(it.sku, float(it.cost), it.map_price, rules))
    return {"supplier_key": req.supplier_key, "count": len(rows), "rows": rows}
# === EC_PRICING_END ===

# Allow the React dev server
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "http://127.0.0.1:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- Demo endpoints used by SuppliersPage ---
@app.get("/api/suppliers")
def list_suppliers():
    return [
        {"id": "KMC", "key": "KMC", "name": "KMC Music", "location": "USA"},
        {"id": "ENSOUL", "key": "ENSOUL", "name": "Ensoul Music", "location": "USA"},
        {"id": "CHESBRO", "key": "CHESBRO", "name": "Chesbro Music", "location": "USA"},
    ]

@app.get("/api/suppliers/{supplier_id}")
def supplier_detail(supplier_id: str):
    return {
        "id": supplier_id,
        "key": supplier_id,
        "name": supplier_id,
        "location": "USA",
        "notes": "Demo detail endpoint",
    }

# Optional: pricing preview endpoints SuppliersPage probes
@app.get("/api/suppliers/{supplier_id}/pricing_preview")
def pricing_preview_supplier(supplier_id: str):
    return {"rows": []}

@app.get("/api/kmc/pricing_preview")
def pricing_preview_kmc():
    return {"rows": []}

@app.get("/api/pricing/kmc_preview")
def pricing_preview_kmc_alt():
    return {"rows": []}

# -------------------------------------------------------------------
# UI compatibility endpoints (React dashboard expects these)
# -------------------------------------------------------------------

@app.get("/health")
def health():
    return {"ok": True}

@app.get("/dashboard/kpis")
def dashboard_kpis():
    # Placeholder metrics until real data wiring is implemented
    return {
        "totalSales7d": 0,
        "orders7d": 0,
        "returns7d": 0,
        "itemsSold7d": 0
    }

@app.get("/dashboard/orders_recent")
def dashboard_orders_recent():
    return []

@app.get("/dashboard/stock_alerts")
def dashboard_stock_alerts():
    return []
